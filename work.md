# Work Log

2026-01-04T02:47:46.480Z --- 增加账号/登录、API Key、配额与监控（Redis+PostgreSQL）--- 新增 Postgres 表结构(sql/001_init.sql)，引入 AUTH_MODE=db|env|both；实现 /auth、/me/api-keys；/mcp 按 UTC 日对 tools/call 做配额与 7 天游标；/admin 增加 DB/配额概览 --- 修改了 package.json pnpm-lock.yaml .env.example docker-compose.yml README.md src/index.ts src/admin.ts src/db.ts src/quota.ts src/mcpQuota.ts src/security.ts；新增 sql/001_init.sql src/config.ts src/auth.ts src/me.ts src/mcpAuth.ts src/requestLog.ts src/lastUsed.ts src/redisLike.ts work.md
2026-01-04T03:50:13Z --- 修复 Admin 可直接访问 Bug + 新增 Dashboard（注册/登录/Key 管理）--- 修复 admin_session 清理 Path；引入 API_KEY_ENCRYPTION_SECRET 并用 AES-256-GCM 加密存储 API Key 明文，支持 Dashboard 点击复制临时解密；新增 /dashboard 页面版注册/登录与 Key 表格 --- 修改了 src/admin.ts src/index.ts src/config.ts src/me.ts src/mcpAuth.ts sql/001_init.sql .env.example docker-compose.yml README.md work.md；新增 sql/002_api_keys_secret_enc.sql src/cryptoBox.ts src/dashboard.ts
2026-01-04T06:14:57Z --- Dashboard UI 对齐 Admin 风格 --- 抽出共享 UI（baseStyles/layoutHtml 等）到 src/ui.ts；/dashboard/login /dashboard/register /dashboard 页面复用 Admin 的 topbar/card/table 结构；Admin 同步改为 import 共享 UI，避免样式漂移 --- 修改了 src/ui.ts src/admin.ts src/dashboard.ts work.md
2026-01-04T06:28:59Z --- 隐藏 Admin 入口 + 会话 3 小时过期（绝对过期）--- Dashboard 页面移除所有 /admin 链接；防止 AUTH_SESSION_COOKIE_NAME 与 admin cookie 冲突；Admin/Dashboard 会话默认 TTL 调整为 10800 秒，并同步文档与示例 --- 修改了 src/dashboard.ts src/config.ts src/index.ts .env.example README.md work.md
2026-01-04T06:57:24Z --- 将 Admin 内容迁移到 Dashboard + Admin 改为后端管理（最小可用）--- Dashboard 增加 Overview/Usage/API Keys/Connect/API/Limits 多页签并新增 /dashboard/api/stats（严格按当前账号汇总）；Admin 改为账号禁用/启用与 Key 吊销；mcpAuth 增加账号禁用标记（Redis）避免缓存窗口 --- 修改了 src/index.ts src/admin.ts src/dashboard.ts src/mcpAuth.ts work.md
2026-01-04T08:19:49Z --- 美化 Admin 表格时间/状态/操作样式 --- Created/Last Used 改为 UTC 两行展示（日期+时间）；Status 增加点状徽标与更明确的颜色语义；Actions 在表格内使用更紧凑按钮并统一对齐 --- 修改了 src/ui.ts src/admin.ts dist/ui.js dist/admin.js work.md
2026-01-04T07:27:27Z --- 修复 Docker 运行时报错 s.replaceAll is not a function --- escapeHtml/escapeAttr 入参改为 unknown 并做 String() 兜底，避免非字符串导致崩溃；重建 dist --- 修改了 src/ui.ts work.md
2026-01-04T07:47:26Z --- Dashboard API 页代码块自动换行/防溢出 --- 修复 grid 下 pre 撑破布局：为 API 区块加 api-grid 宽度约束（minmax(0,1fr)+min-width:0），并启用 pre-wrap+overflow-wrap:anywhere 实现视觉换行 --- 修改了 src/dashboard.ts src/ui.ts work.md
2026-01-04 16:51:24 --- Dashboard API 页 curl 示例显示太丑（转义符/双重 stringify） --- 改为多行 JSON + Bash 单引号包裹，去掉 \\n/\\\" 展示，保持可复制执行 --- src/dashboard.ts, work.md
2026-01-04 17:18:01 --- 修复 Admin 时间渲染崩溃（v.split is not a function）--- fmtIso 兼容 Date/非字符串并统一输出字符串，renderWhenUtc 入参放宽以匹配运行时类型 --- 修改了 src/admin.ts work.md
2026-01-04 17:46:52 --- Dashboard/Admin 增加 ECharts 折线图 --- pnpm 安装 echarts；服务端提供 /assets/echarts.min.js；Dashboard 与 Admin 增加「今日 24 小时」与「近 7 天」UTC 聚合折线图（allowed/denied），并在统计接口中补齐时间序列缺口 --- 修改了 package.json pnpm-lock.yaml src/index.ts src/ui.ts src/dashboard.ts src/admin.ts work.md
2026-01-04 18:12:09 --- 调整图表高度与图例布局（避免挤压） --- .chart 高度提升到桌面 320px/移动 260px；ECharts 调整 legend 固定顶部与 grid 留白（containLabel）以避免线条、坐标轴与图例挤在一起 --- 修改了 src/ui.ts src/dashboard.ts src/admin.ts work.md
2026-01-04 18:19:34 --- 修复 Admin「近 7 天」折线图无数据 --- 统一近 7 天聚合 key 输出为 YYYYMMDD，与 utcDayKey labels 一致，避免 Map key 不匹配导致曲线全 0 --- 修改了 src/index.ts work.md
2026-01-04 18:24:04 --- 修复图表 hover 导致折线“消失” --- 禁用 ECharts 默认 emphasis/blur 弱化行为（focus=none，blur opacity=1），并关闭 legend 点击隐藏系列（selectedMode=false），确保悬浮提示不影响折线可见性 --- 修改了 src/dashboard.ts src/admin.ts work.md
2026-01-04 18:30:16 --- 再次修复图表 hover 弱化/隐藏折线（硬禁用） --- 将折线 series 的 emphasis 直接 disabled，并禁用 select 状态，避免 ECharts 在 axis tooltip hover 时触发 highlight/downplay 导致线条变淡/看似消失 --- 修改了 src/dashboard.ts src/admin.ts work.md
2026-01-04 18:41:23 --- Dashboard Quota 改为圆环图+文本展示 --- Overview 原位置将 Quota 单行输入框替换为 ECharts 圆环图（used/remaining）+ 文本（已用/剩余或超额）；保持 ECharts 失败时文本可用 --- 修改了 src/dashboard.ts dist/dashboard.js work.md
2026-01-04 20:27:12 --- 更换 Admin/Dashboard Logo 为图片 --- 将 public/logo.png 通过 /assets/logo.png 对外提供；Admin/Dashboard 的 .logo 改为 <img> 渲染并补充 .logo-img 样式；Docker 镜像增加 public/ 拷贝 --- 修改了 src/index.ts src/ui.ts src/admin.ts src/dashboard.ts Dockerfile work.md public/logo.png
2026-01-04 20:46:16 --- 更换浏览器 Tab 图标（favicon）--- 在 layoutHtml 的 head 注入 favicon/manifest 链接；增加 /favicon.ico 等根路径重定向；生成多尺寸图标（16/32/180/192/512）与圆角裁切风格的 favicon.svg --- 修改了 src/ui.ts src/index.ts public/favicon.svg public/site.webmanifest public/favicon-16x16.png public/favicon-32x32.png public/apple-touch-icon.png public/android-chrome-192x192.png public/android-chrome-512x512.png work.md
2026-01-04 21:33:34 --- 新增主页（/）对齐 Dashboard 风格 --- 新增 src/home.ts 提供公开 Landing Page（复用 src/ui.ts tokens），并在 src/index.ts 注册 GET /；为主页补齐语义化样式类，避免行内样式与硬编码颜色 --- 修改了 src/home.ts src/index.ts src/ui.ts work.md
2026-01-04 21:47:49 --- /health 根据请求头返回不同结果（浏览器返回 HTML） --- 基于 Accept 做内容协商：默认 JSON；支持 ?format=json|html 强制覆盖；HTML 复用 layoutHtml/baseStyles 展示关键状态与 curl 示例 --- 修改了 src/index.ts work.md
2026-01-05 00:43:52 --- 注册/登录/后台登录强制验证码 --- 引入 svg-captcha 生成 6 位验证码（默认 3 分钟、忽略大小写），使用 express-session 绑定会话并将验证码文本存入 Redis；/auth(login/register) 与 /dashboard(login/register) 与 /admin/login 全部增加一次性验证码校验 --- 修改了 package.json pnpm-lock.yaml src/captcha.ts src/config.ts src/index.ts src/auth.ts src/dashboard.ts src/admin.ts .env.example README.md work.md
2026-01-05 01:00:59 --- 登录失败改为弹窗提示（方案B） --- Dashboard/Admin 登录与注册页改为 fetch(AJAX) 提交：服务端返回 JSON 错误，前端 toast 弹窗展示并自动刷新验证码，避免跳转到 401 Invalid credentials 页面 --- 修改了 src/ui.ts src/dashboard.ts src/admin.ts work.md
